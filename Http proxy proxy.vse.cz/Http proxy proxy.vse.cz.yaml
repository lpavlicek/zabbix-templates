zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: a1c09fe31fae4b56b41195ab9b4910ff
      name: 'lpavlicek templates'
  templates:
    - uuid: fb6b12c508c44be68193e518fe8fb3bd
      template: 'Http proxy proxy.vse.cz'
      name: 'Http proxy proxy.vse.cz'
      description: 'Testování pravidel na proxy.vse.cz'
      vendor:
        name: lpavlicek
        version: 7.4-3
      groups:
        - name: 'lpavlicek templates'
      items:
        - uuid: 82059d0cfc044c458f36919686b24ddf
          name: 'Proxy: port 3128, availability'
          type: SIMPLE
          key: 'net.tcp.service[tcp,{$PROXY_HOST},3128]'
          delay: 2m
          valuemap:
            name: 'Tcp service status'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 59b46ec123aa44d0ba77941050d10fbf
              expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              name: 'Proxy: port 3128 isn''t available/open'
              priority: AVERAGE
              tags:
                - tag: component
                  value: proxy
        - uuid: 0dc59c03b95d419da2e14bde94fe7116
          name: 'Proxy: port 8080, availability'
          type: SIMPLE
          key: 'net.tcp.service[tcp,{$PROXY_HOST},8080]'
          delay: 2m
          valuemap:
            name: 'Tcp service status'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 1a8b76f90a0c4ddaa548c6e0c8fbe6bf
              expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              name: 'Proxy: port 8080 isn''t available/open'
              priority: AVERAGE
              tags:
                - tag: component
                  value: proxy
        - uuid: 50c69285437c4c3e8ef709ce062878b1
          name: 'Proxy: port 3128, rule allow debian.org'
          type: HTTP_AGENT
          key: proxy.3128.allow.debian.org
          delay: 5m
          value_type: CHAR
          description: |
            na portu 3128 jsou dostupné jen vybrané služby:
            - windowsupdate,
            - aktualizace debianu/ubuntu,
            - aktualizace synology,
            a další ...
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://debian.org'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:3128/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 9818a36326744a93a55ed7d8e1b722f6
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.3128.allow.debian.org))>0'
              name: 'Proxy: port 3128 - no valid response for http://debian.org'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: |
                Na portu 3128 by požadavky na aktualizace debian měly procházet. Nejčastější důvody chyby:
                - není dostupný cílový server,
                - chybná pravidla na proxy
              dependencies:
                - name: 'Proxy: port 3128 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: d2b451af98d24c7988da145a4a462da5
          name: 'Proxy: port 3128, rule block google.com'
          type: HTTP_AGENT
          key: proxy.3128.block.google.com
          delay: 5m
          value_type: CHAR
          description: |
            na portu 3128 jsou dostupné jen vybrané služby:
            - windowsupdate,
            - aktualizace debianu/ubuntu,
            - aktualizace synology,
            a další ...
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://google.com'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:3128/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: ea41b010096c4d82b46feef267e57cd1
              expression: 'last(/Http proxy proxy.vse.cz/proxy.3128.block.google.com)<>"ERR_ACCESS_DENIED"'
              name: 'Proxy: port 3128 - response for http://google.com different from ERR_ACCESS_DENIED'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: 'Na portu 3128 je povolen přístup jen na vybrané služby, google je zakázán.'
              dependencies:
                - name: 'Proxy: port 3128 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: 7b2749df9ab143e8b3151a4fa18f63df
          name: 'Proxy: port 8080, rule allow wikipedia.cz'
          type: HTTP_AGENT
          key: proxy.8080.allow.wikipedia.cz
          delay: 5m
          value_type: CHAR
          description: 'na portu 8080 by mělo být dostupné vše s výjimkou sociálních sítí, porna a her'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://wikipedia.cz/'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8080/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 8296c7a1a7564835b1a6c4050ccd0214
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.8080.allow.wikipedia.cz))>0'
              name: 'Proxy: port 8080 - no valid response for http://wikipedia.cz'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: |
                Na portu 8080 by požadavky na wikipedia.cz měly procházet. Nejčastější důvody chyby:
                - není dostupný cílový server,
                - chybná pravidla na proxy
              dependencies:
                - name: 'Proxy: port 8080 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: 0fbb7e4c6fed4e9ab79dccb886f09d9c
          name: 'Proxy: port 8080, rule block facebook.com'
          type: HTTP_AGENT
          key: proxy.8080.block.facebook.com
          delay: 5m
          value_type: CHAR
          description: 'přes port 8080 nejsou dostupné sociální sítě, porno, hry'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://facebook.com'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8080/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: b98b19710ea24214b25578acf9e95795
              expression: 'last(/Http proxy proxy.vse.cz/proxy.8080.block.facebook.com)<>"ERR_ACCESS_DENIED"'
              name: 'Proxy: port 8080 - response for http://facebook.com different from ERR_ACCESS_DENIED'
              priority: WARNING
              description: 'Na portu 8080 jsou zakázány sociální sítě (včetně facebook), hry, porno. Proxy server by měl vracet ERR_ACCESS_DENIED.'
              dependencies:
                - name: 'Proxy: port 8080 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              tags:
                - tag: component
                  value: proxy
      tags:
        - tag: component
          value: proxy
      macros:
        - macro: '{$PROXY_HOST}'
          value: proxy.vse.cz
          description: 'Hostname or IP address of the proxy server'
      valuemaps:
        - uuid: 9cd844e18c6b46339cc15a414a76fe77
          name: 'Tcp service status'
          mappings:
            - value: '0'
              newvalue: down
            - value: '1'
              newvalue: up
