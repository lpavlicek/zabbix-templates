zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: a1c09fe31fae4b56b41195ab9b4910ff
      name: 'lpavlicek templates'
  templates:
    - uuid: fb6b12c508c44be68193e518fe8fb3bd
      template: 'Http proxy proxy.vse.cz'
      name: 'Http proxy proxy.vse.cz'
      description: 'Testování pravidel na proxy.vse.cz'
      vendor:
        name: lpavlicek
        version: 7.4-4
      groups:
        - name: 'lpavlicek templates'
      items:
        - uuid: 8b12f59fd5ab45cba8b3ec0266de6177
          name: 'Proxy: icmpping ipv4'
          type: SIMPLE
          key: 'icmpping[{$PROXY_IPV4}]'
          delay: 2m
          valuemap:
            name: 'ICMP status'
          preprocessing:
            - type: CHECK_NOT_SUPPORTED
              parameters:
                - '-1'
              error_handler: CUSTOM_VALUE
              error_handler_params: '2'
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          tags:
            - tag: component
              value: proxy
        - uuid: 2d5e41ecdc534b349eb2be4b92192fe3
          name: 'Proxy: icmpping ipv6'
          type: SIMPLE
          key: 'icmpping[{$PROXY_IPV6}]'
          delay: 2m
          valuemap:
            name: 'ICMP status'
          preprocessing:
            - type: CHECK_NOT_SUPPORTED
              parameters:
                - '-1'
              error_handler: CUSTOM_VALUE
              error_handler_params: '2'
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          tags:
            - tag: component
              value: proxy
        - uuid: 82059d0cfc044c458f36919686b24ddf
          name: 'Proxy: port 3128'
          type: SIMPLE
          key: 'net.tcp.service[tcp,{$PROXY_HOST},3128]'
          delay: 2m
          description: 'proxy host: {$PROXY_HOST}'
          valuemap:
            name: 'Tcp service status'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 59b46ec123aa44d0ba77941050d10fbf
              expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              name: 'Proxy: port 3128 isn''t available/open'
              priority: AVERAGE
              tags:
                - tag: component
                  value: proxy
        - uuid: 0dc59c03b95d419da2e14bde94fe7116
          name: 'Proxy: port 8080'
          type: SIMPLE
          key: 'net.tcp.service[tcp,{$PROXY_HOST},8080]'
          delay: 2m
          description: 'proxy host: {$PROXY_HOST}'
          valuemap:
            name: 'Tcp service status'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 1a8b76f90a0c4ddaa548c6e0c8fbe6bf
              expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              name: 'Proxy: port 8080 isn''t available/open'
              priority: AVERAGE
              tags:
                - tag: component
                  value: proxy
        - uuid: 6601f9cb987343a0bc8169325ef7d11a
          name: 'Proxy: port 8888'
          type: SIMPLE
          key: 'net.tcp.service[tcp,{$PROXY_HOST},8888]'
          delay: 2m
          description: 'proxy host: {$PROXY_HOST}'
          valuemap:
            name: 'Tcp service status'
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 10m
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 5f76bcce1f6249929b59554209c9677e
              expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8888]) = 0'
              name: 'Proxy: port 8888 isn''t available/open'
              priority: AVERAGE
              tags:
                - tag: component
                  value: proxy
        - uuid: 50c69285437c4c3e8ef709ce062878b1
          name: 'Proxy: port 3128, rule allow debian.org'
          type: HTTP_AGENT
          key: proxy.3128.allow.debian.org
          delay: 5m
          value_type: CHAR
          description: |
            na portu 3128 jsou dostupné jen vybrané služby:
            - windowsupdate,
            - aktualizace debianu/ubuntu,
            - aktualizace synology,
            a další ...
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://debian.org'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:3128/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 9818a36326744a93a55ed7d8e1b722f6
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.3128.allow.debian.org))>0'
              name: 'Proxy: port 3128 - no valid response for http://debian.org'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: |
                Na portu 3128 by požadavky na aktualizace debian měly procházet. Nejčastější důvody chyby:
                - není dostupný cílový server,
                - chybná pravidla na proxy
              dependencies:
                - name: 'Proxy: port 3128 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: d2b451af98d24c7988da145a4a462da5
          name: 'Proxy: port 3128, rule block google.com'
          type: HTTP_AGENT
          key: proxy.3128.block.google.com
          delay: 5m
          value_type: CHAR
          description: |
            na portu 3128 jsou dostupné jen vybrané služby:
            - windowsupdate,
            - aktualizace debianu/ubuntu,
            - aktualizace synology,
            a další ...
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://google.com'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:3128/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: ea41b010096c4d82b46feef267e57cd1
              expression: 'last(/Http proxy proxy.vse.cz/proxy.3128.block.google.com)<>"ERR_ACCESS_DENIED"'
              name: 'Proxy: port 3128 - response for http://google.com different from ERR_ACCESS_DENIED'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: 'Na portu 3128 je povolen přístup jen na vybrané služby, google je zakázán.'
              dependencies:
                - name: 'Proxy: port 3128 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},3128])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: 7b2749df9ab143e8b3151a4fa18f63df
          name: 'Proxy: port 8080, rule allow wikipedia.cz'
          type: HTTP_AGENT
          key: proxy.8080.allow.wikipedia.cz
          delay: 5m
          value_type: CHAR
          description: 'na portu 8080 by mělo být dostupné vše s výjimkou sociálních sítí, porna a her'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://wikipedia.cz/'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8080/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: 8296c7a1a7564835b1a6c4050ccd0214
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.8080.allow.wikipedia.cz))>0'
              name: 'Proxy: port 8080 - no valid response for http://wikipedia.cz'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              description: |
                Na portu 8080 by požadavky na wikipedia.cz měly procházet. Nejčastější důvody chyby:
                - není dostupný cílový server,
                - chybná pravidla na proxy
              dependencies:
                - name: 'Proxy: port 8080 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: 0fbb7e4c6fed4e9ab79dccb886f09d9c
          name: 'Proxy: port 8080, rule block facebook.com'
          type: HTTP_AGENT
          key: proxy.8080.block.facebook.com
          delay: 5m
          value_type: CHAR
          description: 'přes port 8080 nejsou dostupné sociální sítě, porno, hry'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://facebook.com'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8080/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: b98b19710ea24214b25578acf9e95795
              expression: 'last(/Http proxy proxy.vse.cz/proxy.8080.block.facebook.com)<>"ERR_ACCESS_DENIED"'
              name: 'Proxy: port 8080 - response for http://facebook.com different from ERR_ACCESS_DENIED'
              priority: WARNING
              description: 'Na portu 8080 jsou zakázány sociální sítě (včetně facebook), hry, porno. Proxy server by měl vracet ERR_ACCESS_DENIED.'
              dependencies:
                - name: 'Proxy: port 8080 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8080])=0'
              tags:
                - tag: component
                  value: proxy
        - uuid: bb2fc7486229410d837e8693701f9b13
          name: 'Proxy: port 8888, rule allow www.cms2.cz'
          type: HTTP_AGENT
          key: proxy.8888.allow.cms2.cz
          delay: 5m
          value_type: CHAR
          description: 'na www.cms2.cz by měl být přístup jen přes port 8888'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://www.cms2.cz/'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8888/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: b4349065e0ff429bab33caf35c9ea08c
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.8888.allow.cms2.cz))>0'
              name: 'Proxy: port 8888 - no valid response for http://www.cms2.cz'
              dependencies:
                - name: 'Proxy: port 8888 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8888]) = 0'
              tags:
                - tag: component
                  value: proxy
        - uuid: 23facdc5e88545e192d6d9c7827c73fc
          name: 'Proxy: port 8888, rule allow nms.vse.cz'
          type: HTTP_AGENT
          key: proxy.8888.allow.nms.vse.cz
          delay: 5m
          value_type: CHAR
          description: 'Na portu 8888 by měl být stejný přístup jako na portu 8080.'
          preprocessing:
            - type: REGEX
              parameters:
                - 'X-Squid-Error: (\S+)'
                - \1
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          timeout: 10s
          url: 'http://nms.vse.cz/'
          status_codes: ''
          follow_redirects: 'NO'
          http_proxy: 'http://{$PROXY_HOST}:8888/'
          retrieve_mode: HEADERS
          request_method: HEAD
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: b3b81e629ffb4534a00a1aa798e722f0
              expression: 'length(last(/Http proxy proxy.vse.cz/proxy.8888.allow.nms.vse.cz)) > 0'
              name: 'Proxy: port 8888 - no valid response for http://nms.vse.cz'
              opdata: '{ITEM.VALUE}'
              priority: WARNING
              dependencies:
                - name: 'Proxy: port 8888 isn''t available/open'
                  expression: 'last(/Http proxy proxy.vse.cz/net.tcp.service[tcp,{$PROXY_HOST},8888]) = 0'
              tags:
                - tag: component
                  value: proxy
        - uuid: f3be2d7ef8d04130bc7cae18b13ab53f
          name: 'Proxy: file /etc/squid/dstd_pornsites'
          key: 'vfs.file.time[/etc/squid/dstd_pornsites,modify]'
          delay: 10m
          units: s
          description: 'Jak starý je soubor /etc/squid/dstd_pornsites'
          preprocessing:
            - type: CHECK_NOT_SUPPORTED
              parameters:
                - '-1'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          tags:
            - tag: component
              value: proxy
          triggers:
            - uuid: c71e2a1295264ccba7aef9005197822a
              expression: |
                last(/Http proxy proxy.vse.cz/vfs.file.time[/etc/squid/dstd_pornsites,modify]) < now() - 32d
                and last(/Http proxy proxy.vse.cz/vfs.file.time[/etc/squid/dstd_pornsites,modify]) > 0
              name: 'Proxy: file /etc/squid/dstd_pornsites is old (> 32 days)'
              priority: INFO
              description: |
                Soubory  /etc/squid/dstd_pornsites a /etc/squid/ /etc/squid/dstd_socialnet je potřeba aspoň jednou za měsíc aktualizovat. 
                Poslední změna souboru: {ITEM.VALUE}
              manual_close: 'YES'
              tags:
                - tag: component
                  value: proxy
            - uuid: 879fbbde22034a35a4bc309d8adb9286
              expression: 'last(/Http proxy proxy.vse.cz/vfs.file.time[/etc/squid/dstd_pornsites,modify]) < now() - 90d'
              name: 'Proxy: file /etc/squid/dstd_pornsites missing or too old (> 90 days)'
              priority: WARNING
              description: 'Soubory /etc/squid/dstd_pornsites a /etc/squid/dstd_socialnet jsou příliš staré, nutná aktualizace.'
              tags:
                - tag: component
                  value: proxy
      tags:
        - tag: component
          value: proxy
      macros:
        - macro: '{$PROXY_HOST}'
          value: proxy.vse.cz
          description: 'Hostname or IP address of the proxy server'
        - macro: '{$PROXY_IPV4}'
          value: 192.0.2.1
          description: 'IPv4 address of the proxy server'
        - macro: '{$PROXY_IPV6}'
          value: '2001:db8::1'
          description: 'IPv6 address of the proxy server'
      valuemaps:
        - uuid: 7a760a6c238c485bac5983d4a64e4e2f
          name: 'ICMP status'
          mappings:
            - value: '0'
              newvalue: down
            - value: '1'
              newvalue: up
            - value: '2'
              newvalue: error
        - uuid: 9cd844e18c6b46339cc15a414a76fe77
          name: 'Tcp service status'
          mappings:
            - value: '0'
              newvalue: down
            - value: '1'
              newvalue: up
