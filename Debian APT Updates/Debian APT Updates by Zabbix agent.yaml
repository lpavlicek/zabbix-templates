zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: a1c09fe31fae4b56b41195ab9b4910ff
      name: 'lpavlicek templates'
  templates:
    - uuid: cba0eeda27434a70ae31b69d263a357b
      template: 'Debian APT Updates by Zabbix agent'
      name: 'Debian APT Updates by Zabbix agent'
      description: |
        Zabbix template for monitoring available APT updates on
        Debian and Ubuntu systems using the Zabbix agent and UserParameters.
        
        # List of available APT updates
        UserParameter=apt.updates.total,apt list --upgradable 2>/dev/null | grep /
        
        # Timestamp of the last successful apt update
        UserParameter=apt.updates.last,stat -c %Y  /var/lib/apt/periodic/update-success-stamp  /var/lib/apt/periodic/update-stamp  /var/lib/apt/lists  /var/lib/apt/lists/partial  /var/cache/apt/pkgcache.bin  2>/dev/null | sort -n | tail -1
        
        # List of locally installed packages obtained using a script apt_list_local
        UserParameter=apt.packages.local,/etc/zabbix/scripts/apt/apt_list_local
      vendor:
        name: lpavlicek
        version: 7.4-5
      groups:
        - name: 'lpavlicek templates'
      items:
        - uuid: 5e28e90d57924154adac807a864ad3c7
          name: 'APT: list local packages'
          key: apt.packages.local
          delay: 10m
          value_type: TEXT
          description: |
            List of local packages, i.e., packages installed manually or packages installed from discontinued repositories. 
            Example output obtained via the apt.list.local user parameter:
            synology-active-backup-business-linux-service local hold
            synosnap local hold
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 4h
          tags:
            - tag: component
              value: apt
            - tag: stage
              value: raw
        - uuid: 3bed1e2f9f304d18a8681e6b39fecd9b
          name: 'APT: local packages (count)'
          type: DEPENDENT
          key: apt.packages.local.count
          description: 'The number of local packages, i.e., packages installed manually or packages installed from deprecated repositories.'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  // Rozdělení textu na pole řádků
                  var lines = value.split('\n');
                  var count = 0;
                  
                  for (var i = 0; i < lines.length; i++) {
                      // Kontrola, zda řádek obsahuje podřetězec ' local '
                      if (lines[i].indexOf(' local ') !== -1) {
                          count++;
                      }
                  }
                  
                  return count;
          master_item:
            key: apt.packages.local
          tags:
            - tag: component
              value: apt
        - uuid: ff051473bc6544df9ebd93d5f39123e4
          name: 'APT: local packages without hold (count)'
          type: DEPENDENT
          key: apt.packages.local.count.nohold
          description: 'The number of local packages without the hold flag. If it is greater than zero, the trigger is activated.'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  // Rozdělení vstupu na řádky a filtrace
                  var lines = value.split('\n');
                  var count = 0;
                  
                  for (var i = 0; i < lines.length; i++) {
                      // Kontrola, zda řádek končí textem ' no_hold' 
                      // (odstraníme i případné neviditelné znaky na konci jako \r)
                      if (lines[i].trim().endsWith(' no_hold')) {
                          count++;
                      }
                  }
                  
                  return count;
          master_item:
            key: apt.packages.local
          tags:
            - tag: component
              value: apt
          triggers:
            - uuid: 7fba924edc0c4b659e3d1d612b6c53f8
              expression: 'last(/Debian APT Updates by Zabbix agent/apt.packages.local.count.nohold) > 0'
              name: 'APT: Local packages are installed'
              opdata: '{ITEM.LASTVALUE1} packages'
              priority: INFO
              description: |
                The server contains manually installed packages or packages from removed apt repositories. This often results in outdated packages without security updates.
                Packages marked with hold are not counted.
              tags:
                - tag: component
                  value: apt
        - uuid: 24871758bc3240758ad9515f48aab473
          name: 'APT: upgrade command'
          type: DEPENDENT
          key: apt.updates.cmd
          value_type: TEXT
          description: |
            Generated APT command for upgrading currently pending packages:
            apt-get install --only-upgrade <packages>.
            The command is derived from the list of upgradeable packages and is provided for operational convenience only (not executed by Zabbix).
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  // Input: lines from "apt list --upgradable | grep /"
                  // Output: apt-get install --only-upgrade pkg1 pkg2 ...
                  
                  if (!value) {
                      return "";
                  }
                  
                  var lines = value.trim().split(/\r?\n/);
                  var pkgs = [];
                  
                  for (var i = 0; i < lines.length; i++) {
                      var line = lines[i].trim();
                      if (line === "") {
                          continue;
                      }
                  
                      // Format example:
                      // docker-ce-cli/bookworm 5:29.1.4-1~debian.12~bookworm amd64 [upgradable from: ...]
                      // We want part before the first slash: docker-ce-cli
                  
                      var firstField = line.split(/\s+/)[0]; // docker-ce-cli/bookworm
                      var pkg = firstField.split("/")[0];    // docker-ce-cli
                  
                      if (pkg !== "") {
                          pkgs.push(pkg);
                      }
                  }
                  
                  // Remove duplicates just in case
                  pkgs = pkgs.filter(function(item, pos) {
                      return pkgs.indexOf(item) === pos;
                  });
                  
                  if (pkgs.length === 0) {
                      return "";
                  }
                  
                  return "apt-get install --only-upgrade " + pkgs.join(" ");
          master_item:
            key: apt.updates.list
          tags:
            - tag: component
              value: apt
        - uuid: 689ea50428fb4f1887ad796305fca429
          name: 'APT: last apt update time'
          key: apt.updates.last
          delay: 10m
          units: unixtime
          description: |
            UNIX timestamp of the most recent successful apt update execution.
            Determined from APT state files under /var/lib/apt and /var/cache/apt.
            Collected via Zabbix agent user parameter.
          tags:
            - tag: component
              value: apt
          triggers:
            - uuid: 896f5f139eba49509fdaf3b83e78d2f2
              expression: '(now()-last(/Debian APT Updates by Zabbix agent/apt.updates.last))>  {$APT.UPDATE.MAX.AGE}'
              name: 'APT: apt update not executed for too long'
              opdata: '{ITEM.LASTVALUE1}'
              priority: AVERAGE
              description: |
                The APT package index has not been updated within the defined time threshold ({$APT.UPDATE.MAX.AGE}).
                This may result in outdated or incomplete update information.
              tags:
                - tag: scope
                  value: security
        - uuid: 41fda449d61c4a7eb38114860e153e6d
          name: 'APT: available package updates list'
          key: apt.updates.list
          delay: 10m
          value_type: TEXT
          description: |
            Raw output of apt list --upgradable filtered to package entries.
            This item provides the source data for all dependent items (total count, security, non-security and upgrade command).
            Collected via Zabbix agent user parameter.
          preprocessing:
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 4h
          tags:
            - tag: component
              value: apt
            - tag: stage
              value: raw
        - uuid: c87885d9ecbc4efc9b509b4a5231ac8e
          name: 'APT: non-security updates (count)'
          type: DEPENDENT
          key: apt.updates.nonsecurity
          description: |
            Number of available updates excluding security repositories.
            Calculated as all upgradeable packages minus those matching /.*-security.
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  // Count lines NOT matching: /.*-security (case-insensitive)
                  
                  if (!value) {
                      return 0;
                  }
                  
                  var lines = value.split(/\r?\n/);
                  var re = /\/.*-security/i;
                  var count = 0;
                  
                  for (var i = 0; i < lines.length; i++) {
                      var line = lines[i].trim();
                      if (line === "") {
                          continue;
                      }
                  
                      // Count only non-security lines
                      if (!re.test(line)) {
                          count++;
                      }
                  }
                  
                  return count;
          master_item:
            key: apt.updates.list
          tags:
            - tag: component
              value: apt
          triggers:
            - uuid: a8ebae2be19647c99601127777e2c6c4
              expression: 'min(/Debian APT Updates by Zabbix agent/apt.updates.nonsecurity,11m)>0'
              name: 'APT: Non-security updates are available'
              opdata: '{ITEM.LASTVALUE1} updates'
              priority: WARNING
              description: |
                Non-security package updates are available and persist across multiple checks.
                These updates are typically operational and should be scheduled for regular maintenance.
              tags:
                - tag: scope
                  value: security
        - uuid: f5cc8b96cd384a29a95af27560634929
          name: 'APT: security updates (count)'
          type: DEPENDENT
          key: apt.updates.security
          description: |
            Number of available updates coming from *-security repositories.
            Counted as lines matching the pattern /.*-security (case-insensitive) in the APT upgrade list.
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  // Count lines matching: /.*-security (case-insensitive)
                  
                  if (!value) {
                      return 0;
                  }
                  
                  var lines = value.split(/\r?\n/);
                  var re = /\/.*-security/i;
                  var count = 0;
                  
                  for (var i = 0; i < lines.length; i++) {
                      if (re.test(lines[i])) {
                          count++;
                      }
                  }
                  
                  return count;
          master_item:
            key: apt.updates.list
          tags:
            - tag: component
              value: apt
          triggers:
            - uuid: addbbc26510a4892bce050ac77b3eb3e
              expression: 'min(/Debian APT Updates by Zabbix agent/apt.updates.security, 11m)>0'
              name: 'APT: Security updates are available'
              opdata: '{ITEM.LASTVALUE1} updates'
              priority: AVERAGE
              description: |
                One or more security updates are available and persist across multiple checks.
                Short-lived conditions are suppressed to avoid false positives.
              tags:
                - tag: scope
                  value: security
            - uuid: 661128840bf74d73a65c5e7f482ab65f
              expression: 'min(/Debian APT Updates by Zabbix agent/apt.updates.security, 7d) > 0'
              name: 'APT: Security updates pending for 7 days'
              opdata: '{ITEM.LASTVALUE1} updates'
              priority: HIGH
              description: |
                Security updates have been available for at least 7 days and were not installed.
                This represents a significant security risk.
              dependencies:
                - name: 'APT: Security updates are available'
                  expression: 'min(/Debian APT Updates by Zabbix agent/apt.updates.security, 11m)>0'
              tags:
                - tag: scope
                  value: security
      tags:
        - tag: component
          value: apt
      macros:
        - macro: '{$APT.UPDATE.MAX.AGE}'
          value: 36h
          description: 'Maximum allowed age of the last apt update. If exceeded, a trigger is raised.'
      dashboards:
        - uuid: 83ea4cc92ee245689d389d9583e62a99
          name: APT
          display_period: '60'
          pages:
            - widgets:
                - type: item
                  name: 'Security updates'
                  width: '11'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: decimal_places
                      value: '0'
                    - type: STRING
                      name: description
                      value: 'security updates'
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.updates.security
                    - type: INTEGER
                      name: show.0
                      value: '1'
                    - type: INTEGER
                      name: show.1
                      value: '2'
                    - type: INTEGER
                      name: show.2
                      value: '4'
                    - type: STRING
                      name: thresholds.0.color
                      value: FFCDD2
                    - type: STRING
                      name: thresholds.0.threshold
                      value: '1'
                - type: itemhistory
                  'y': '2'
                  width: '72'
                  height: '5'
                  hide_header: 'YES'
                  fields:
                    - type: STRING
                      name: columns.0.highlights.0.color
                      value: FFCCBC
                    - type: STRING
                      name: columns.0.highlights.0.pattern
                      value: security
                    - type: ITEM
                      name: columns.0.itemid
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.updates.list
                    - type: INTEGER
                      name: columns.0.monospace_font
                      value: '1'
                    - type: STRING
                      name: columns.0.name
                      value: 'Available updates'
                    - type: STRING
                      name: columns.1.highlights.0.color
                      value: FFE0B2
                    - type: STRING
                      name: columns.1.highlights.0.pattern
                      value: apt
                    - type: ITEM
                      name: columns.1.itemid
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.updates.cmd
                    - type: INTEGER
                      name: columns.1.monospace_font
                      value: '1'
                    - type: STRING
                      name: columns.1.name
                      value: 'Upgrade cmd'
                    - type: STRING
                      name: columns.2.highlights.0.color
                      value: B2EBF2
                    - type: STRING
                      name: columns.2.highlights.0.pattern
                      value: no_hold
                    - type: ITEM
                      name: columns.2.itemid
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.packages.local
                    - type: INTEGER
                      name: columns.2.monospace_font
                      value: '1'
                    - type: STRING
                      name: columns.2.name
                      value: 'Local packages'
                    - type: STRING
                      name: reference
                      value: CPTPF
                    - type: INTEGER
                      name: rf_rate
                      value: '120'
                    - type: INTEGER
                      name: show_column_header
                      value: '0'
                    - type: INTEGER
                      name: show_lines
                      value: '3'
                    - type: INTEGER
                      name: show_timestamp
                      value: '1'
                    - type: STRING
                      name: time_period.from
                      value: now-4h
                    - type: STRING
                      name: time_period.to
                      value: now
                - type: item
                  name: 'Non-security updates'
                  x: '11'
                  width: '11'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: decimal_places
                      value: '0'
                    - type: STRING
                      name: description
                      value: 'non-security updates'
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.updates.nonsecurity
                    - type: INTEGER
                      name: show.0
                      value: '1'
                    - type: INTEGER
                      name: show.1
                      value: '2'
                    - type: INTEGER
                      name: show.2
                      value: '4'
                    - type: STRING
                      name: thresholds.0.color
                      value: FFE0B2
                    - type: STRING
                      name: thresholds.0.threshold
                      value: '1'
                - type: item
                  name: 'Local packages'
                  x: '22'
                  width: '11'
                  hide_header: 'YES'
                  fields:
                    - type: INTEGER
                      name: aggregate_function
                      value: '7'
                    - type: INTEGER
                      name: decimal_places
                      value: '0'
                    - type: STRING
                      name: description
                      value: 'local packages'
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Debian APT Updates by Zabbix agent'
                        key: apt.packages.local.count.nohold
                    - type: INTEGER
                      name: show.0
                      value: '1'
                    - type: INTEGER
                      name: show.1
                      value: '2'
                    - type: STRING
                      name: thresholds.0.color
                      value: B2EBF2
                    - type: STRING
                      name: thresholds.0.threshold
                      value: '1'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_show
                      value: '0'
                - type: svggraph
                  x: '33'
                  width: '39'
                  hide_header: 'YES'
                  fields:
                    - type: STRING
                      name: ds.0.color
                      value: E57373
                    - type: STRING
                      name: ds.0.items.0
                      value: 'APT: security updates (count)'
                    - type: INTEGER
                      name: ds.0.missingdatafunc
                      value: '3'
                    - type: INTEGER
                      name: ds.0.stacked
                      value: '1'
                    - type: INTEGER
                      name: ds.0.type
                      value: '2'
                    - type: STRING
                      name: ds.1.color
                      value: FFD54F
                    - type: STRING
                      name: ds.1.items.0
                      value: 'APT: non-security updates (count)'
                    - type: INTEGER
                      name: ds.1.missingdatafunc
                      value: '3'
                    - type: INTEGER
                      name: ds.1.stacked
                      value: '1'
                    - type: INTEGER
                      name: ds.1.type
                      value: '2'
                    - type: INTEGER
                      name: ds.2.aggregate_function
                      value: '3'
                    - type: STRING
                      name: ds.2.color
                      value: B2EBF2
                    - type: STRING
                      name: ds.2.items.0
                      value: 'APT: local packages without hold (count)'
                    - type: INTEGER
                      name: ds.2.stacked
                      value: '1'
                    - type: INTEGER
                      name: ds.2.type
                      value: '3'
                    - type: STRING
                      name: reference
                      value: QWFJA
                    - type: INTEGER
                      name: righty
                      value: '0'
