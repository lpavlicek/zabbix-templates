zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: a1c09fe31fae4b56b41195ab9b4910ff
      name: 'lpavlicek templates'
  templates:
    - uuid: c0d4d5edb5654148a7927b5c1314b85a
      template: 'HTTP to HTTPS Redirect Check'
      name: 'HTTP to HTTPS Redirect Check'
      description: |
        The template tests whether the target host redirects HTTP to HTTPS for aliases specified in the user macro {$HTTP_REDIRECT_ALIASES}.
        
        Requirements:
        - Zabbix server must have network access to monitored hosts on port 80
        - Hosts should respond with 301, 302, or 303 redirect status codes
        
        Configuration:
        1. Set {$HTTP_REDIRECT_ALIASES} macro with comma-separated hostnames
        2. Adjust {$HTTP_REDIRECT_TIMEOUT} if needed (default: 10s)
        
        Monitored metrics:
        - HTTP response status codes
        - Redirect location headers
        - HTTPS protocol validation
        
        Author: lpavlicek
        Repository: https://github.com/lpavlicek/zabbix-templates
      vendor:
        name: lpavlicek
        version: 7.4-6
      groups:
        - name: 'lpavlicek templates'
      items:
        - uuid: d6ea11b3792047e896ec5558556d1268
          name: 'HTTP redirect: Hostnames list'
          type: CALCULATED
          key: http.redirect.hostnames
          delay: 1h
          value_type: TEXT
          params: 'concat("{$HTTP_REDIRECT_ALIASES}","")'
          description: 'Returns the comma-separated list of hostnames defined in the {$HTTP_REDIRECT_ALIASES} macro. This value serves as the data source for LLD (Low-Level Discovery).'
          tags:
            - tag: component
              value: http-redirect
        - uuid: 5414b2284d85492d84be1b814e093b57
          name: 'HTTP redirect: Overall status'
          type: CALCULATED
          key: http.redirect.overall.status
          delay: 5m
          params: |
            1 + 
            between(
             (  item_count(//http.redirect.is_https[*])
                   - sum(last_foreach(//http.redirect.is_https[*]))
             ), 1,999)
          description: |
            Aggregated status of HTTP->HTTPS redirection across all aliases.
            Values: 0 = no aliases configured, 1 = all redirect properly, 2 = some redirects missing or misconfigured.
          valuemap:
            name: 'HTTP redirect: Overall status'
          preprocessing:
            - type: CHECK_NOT_SUPPORTED
              parameters:
                - '-1'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          tags:
            - tag: component
              value: http-redirect
      discovery_rules:
        - uuid: 2467238d33ce4ba19fd72d1cc0ab52cb
          name: 'HTTP redirect: Endpoints discovery'
          type: DEPENDENT
          key: http.redirect.discovery
          description: 'Discovers HTTP redirect endpoints based on the comma-separated list of hostnames in {$HTTP_REDIRECT_ALIASES} macro.'
          item_prototypes:
            - uuid: dba171bb62324bd6ad5f9aff8223353b
              name: 'HTTP redirect: HTTP response headers for {#HOSTNAME}'
              type: HTTP_AGENT
              key: 'http.redirect.check[{#HOSTNAME}]'
              delay: 5m
              value_type: TEXT
              description: |
                Performs HTTP request to {#HOSTNAME} and captures response headers.
                No redirects are followed to verify the initial server response.
                Empty response indicates connection failure, timeout, or DNS resolution error.
              preprocessing:
                - type: CHECK_NOT_SUPPORTED
                  parameters:
                    - '-1'
                  error_handler: CUSTOM_VALUE
              timeout: '{$HTTP_REDIRECT_TIMEOUT}'
              url: 'http://{#HOSTNAME}'
              status_codes: 200-599
              follow_redirects: 'NO'
              headers:
                - name: User-Agent
                  value: 'Zabbix HTTP Redirect Monitor'
              retrieve_mode: HEADERS
              tags:
                - tag: component
                  value: http-redirect
                - tag: stage
                  value: raw
              trigger_prototypes:
                - uuid: af43adde2b0c4069b4a6e3c36f6b524a
                  expression: 'length(last(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}]))=0'
                  name: 'HTTP redirect: No response from {#HOSTNAME}'
                  priority: WARNING
                  description: |
                    HTTP request to {#HOSTNAME} did not receive any response.
                    Possible causes: connection timeout, DNS resolution failure, firewall blocking, or host is unreachable.
                    
                    Recommended action:
                    - Verify network connectivity from Zabbix server to {#HOSTNAME}
                    - Confirm the web server is running on the target host
                    - Check server logs for errors
                    - Verify firewall rules allow HTTP (port 80) traffic
                  tags:
                    - tag: scope
                      value: availability
                - uuid: a23efc30c1374a29a86d04eacca6377f
                  expression: |
                    count(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}],14m,"ne","")=0
                    and
                    nodata(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}],14m)=0
                  name: 'HTTP redirect: No response from {#HOSTNAME} for 10 minutes'
                  priority: AVERAGE
                  description: |
                    HTTP request to {#HOSTNAME} has not received any response for 10 consecutive minutes.
                    This indicates a persistent connectivity or availability issue.
                    
                    Recommended action:
                    - Confirm the web server is running on the target host
                    - Check server logs for errors
                    - Verify firewall rules allow HTTP (port 80) traffic
                  tags:
                    - tag: scope
                      value: availability
            - uuid: 5bf0787d811c4a1db956c04ca85f0b3a
              name: 'HTTP redirect: Location contains HTTPS for {#HOSTNAME}'
              type: DEPENDENT
              key: 'http.redirect.is_https[{#HOSTNAME}]'
              description: 'Validates if the Location header in the redirect response starts with "https://". Returns 1 if HTTPS is used, 0 otherwise.'
              valuemap:
                name: 'HTTP redirect: HTTPS validation'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      var location = value.trim();
                      if (location.toLowerCase().startsWith('https://')) {
                        return 1;
                      }
                      return 0;
              master_item:
                key: 'http.redirect.location[{#HOSTNAME}]'
              tags:
                - tag: component
                  value: http-redirect
            - uuid: d9f56f1650244345a2d19a18eb5fd04c
              name: 'HTTP redirect: Location for {#HOSTNAME}'
              type: DEPENDENT
              key: 'http.redirect.location[{#HOSTNAME}]'
              value_type: TEXT
              description: 'Extracts the URL from the Location header of the HTTP redirect response. Returns empty string if no Location header is present.'
              preprocessing:
                - type: REGEX
                  parameters:
                    - '(?i)Location:\s*([^\r\n]+)'
                    - \1
                  error_handler: CUSTOM_VALUE
                  error_handler_params: ''''''
              master_item:
                key: 'http.redirect.check[{#HOSTNAME}]'
              tags:
                - tag: component
                  value: http-redirect
            - uuid: 82b5450639c44c3bbe619a143d328429
              name: 'HTTP redirect: HTTP status code for {#HOSTNAME}'
              type: DEPENDENT
              key: 'http.redirect.status[{#HOSTNAME}]'
              description: 'Extracts the HTTP status code from the response. Returns 0 if no valid status code is found.'
              preprocessing:
                - type: REGEX
                  parameters:
                    - 'HTTP/\d(\.\d)?\s+(\d+)'
                    - \2
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: 'http.redirect.check[{#HOSTNAME}]'
              tags:
                - tag: component
                  value: http-redirect
              trigger_prototypes:
                - uuid: 2cc6447512964898a14537631dd793ce
                  expression: |
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>301 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>302 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>303 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>0
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: |
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=301 or
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=302 or
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=303
                  name: 'HTTP redirect: No HTTP redirect for {#HOSTNAME}'
                  priority: WARNING
                  description: |
                    The server at {#HOSTNAME} returned status code {ITEM.LASTVALUE1} instead of a redirect (301/302/303).
                    This means HTTP traffic is NOT being redirected to HTTPS, which is a security risk.
                    
                    Recommended action:
                    - Configure web server to redirect HTTP to HTTPS
                    - For Apache: Use mod_rewrite or Redirect directive
                    - For Nginx: Use return 301 https://$host$request_uri;
                  dependencies:
                    - name: 'HTTP redirect: No response from {#HOSTNAME}'
                      expression: 'length(last(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}]))=0'
                  tags:
                    - tag: component
                      value: http-redirect
                    - tag: scope
                      value: security
          trigger_prototypes:
            - uuid: e61908982610413b9da08fb00539456d
              expression: |
                last(/HTTP to HTTPS Redirect Check/http.redirect.is_https[{#HOSTNAME}])=0 and
                length(last(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}]))>0
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'last(/HTTP to HTTPS Redirect Check/http.redirect.is_https[{#HOSTNAME}])=1'
              name: 'HTTP redirect: Target is not HTTPS for {#HOSTNAME}'
              priority: AVERAGE
              description: |
                The redirect location header does not start with 'https://'.
                Location: {ITEM.LASTVALUE1}
                
                This creates a security vulnerability as users may be redirected to an insecure HTTP URL.
                
                Recommended action:
                - Update redirect configuration to use HTTPS protocol
              dependencies:
                - name: 'HTTP redirect: No HTTP redirect for {#HOSTNAME}'
                  expression: |
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>301 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>302 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>303 and
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])<>0
                  recovery_expression: |
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=301 or
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=302 or
                    last(/HTTP to HTTPS Redirect Check/http.redirect.status[{#HOSTNAME}])=303
                - name: 'HTTP redirect: No response from {#HOSTNAME}'
                  expression: 'length(last(/HTTP to HTTPS Redirect Check/http.redirect.check[{#HOSTNAME}]))=0'
              tags:
                - tag: component
                  value: http-redirect
                - tag: scope
                  value: security
          master_item:
            key: http.redirect.hostnames
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var hostnames = value.split(',').map(function(h) { return h.trim(); }).filter(function(h) { return h.length > 0; });
                  var result = [];
                  for (var i = 0; i < hostnames.length; i++) {
                    result.push({
                      "{#HOSTNAME}": hostnames[i]
                    });
                  }
                  return JSON.stringify(result);
      tags:
        - tag: component
          value: http-redirect
      macros:
        - macro: '{$HTTP_REDIRECT_ALIASES}'
          description: 'Comma-separated list of hostnames/aliases to check for HTTP to HTTPS redirect. Example: example.com,www.example.com,api.example.com Note: Use DNS names or IP addresses without protocol prefix (http:// or https://).'
        - macro: '{$HTTP_REDIRECT_TIMEOUT}'
          value: '10'
          description: 'Timeout for HTTP request in seconds. Increase if monitoring hosts with slow response times or over high-latency networks.'
      valuemaps:
        - uuid: 3cfee0175ee642e6bbcca8d2fb0e67cb
          name: 'HTTP redirect: HTTPS validation'
          mappings:
            - value: '0'
              newvalue: 'Not HTTPS'
            - value: '1'
              newvalue: 'To HTTPS'
        - uuid: 30b9a1d7dcf74c43b74f545434394b60
          name: 'HTTP redirect: Overall status'
          mappings:
            - value: '0'
              newvalue: 'No HTTP monitored'
            - value: '1'
              newvalue: 'All redirect to HTTPS'
            - type: GREATER_OR_EQUAL
              value: '2'
              newvalue: 'Some redirects missing'
